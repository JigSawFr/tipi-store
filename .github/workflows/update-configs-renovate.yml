name: Update & Validate Metadata & Configs of Upgraded Apps

on:
  push:
    branches: [main, master]
  pull_request:
    types: [opened, reopened]
    branches: [main, master]
  workflow_dispatch:

# Prevent concurrent runs on the same PR
concurrency:
  group: renovate-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Job for Renovate PRs - handles automatic updates and merging
  update-and-validate-configs-renovate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: >
      github.event_name == 'pull_request' &&
      github.event.pull_request.user.login == 'renovate[bot]' &&
      (
        github.event.action == 'opened' ||
        github.event.action == 'reopened'
      ) &&
      (
        contains(github.event.pull_request.title, 'chore(deps)')
      )
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ssh-key: ${{ secrets.DEPLOY_KEY }}

      - name: Configure Git pull strategy
        run: |
          echo "âš™ï¸ Configuring Git to handle divergent branches..."
          git config pull.rebase false
          echo "âœ… Git configured to use merge strategy for pulls"

      - name: Check if last commit is from our workflow
        id: check_workflow_commit
        run: |
          echo "ðŸ” Checking if last commit was made by this workflow..."
          LAST_COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
          LAST_COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
          echo "Last commit message: $LAST_COMMIT_MESSAGE"
          echo "Last commit author: $LAST_COMMIT_AUTHOR"

          if [[ "$LAST_COMMIT_MESSAGE" == *"ðŸ”§ Fixed: increment tipi_version for Docker image updates"* ]] && [[ "$LAST_COMMIT_AUTHOR" == "github-actions[bot]" ]]; then
            echo "ðŸ›‘ Last commit was made by this workflow, stopping execution to prevent infinite loop"
            echo "skip_execution=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Last commit was not made by this workflow, proceeding"
            echo "skip_execution=false" >> $GITHUB_OUTPUT
          fi

      - name: Stop execution if workflow loop detected
        if: steps.check_workflow_commit.outputs.skip_execution == 'true'
        run: |
          echo "ðŸ”„ Workflow execution stopped to prevent infinite loop"
          echo "â„¹ï¸  Last commit was generated by this workflow"
          exit 0

      - name: Get list of apps changed in the PR
        id: changed_apps
        if: steps.check_workflow_commit.outputs.skip_execution == 'false'
        uses: tj-actions/changed-files@v46
        with:
          files: apps/*/docker-compose.json

      - name: Backup previous config.json tipi_version
        if: steps.check_workflow_commit.outputs.skip_execution == 'false' && steps.changed_apps.outputs.any_changed == 'true'
        shell: pwsh
        env:
          CHANGED_FILES: ${{ steps.changed_apps.outputs.all_changed_files }}
        run: |
          pwsh ./.github/scripts/backup-config.ps1

      - name: Update config.json only for changed apps (PR Renovate)
        if: steps.check_workflow_commit.outputs.skip_execution == 'false' && steps.changed_apps.outputs.any_changed == 'true'
        shell: pwsh
        env:
          CHANGED_FILES: ${{ steps.changed_apps.outputs.all_changed_files }}
        run: |
          pwsh ./.github/scripts/update-config.ps1

      - name: Check config.json update consistency
        if: steps.check_workflow_commit.outputs.skip_execution == 'false' && steps.changed_apps.outputs.any_changed == 'true'
        shell: pwsh
        env:
          CHANGED_FILES: ${{ steps.changed_apps.outputs.all_changed_files }}
        run: |
          pwsh ./.github/scripts/validate-config.ps1

      - name: Commit and push config.json updates
        if: steps.check_workflow_commit.outputs.skip_execution == 'false' && steps.changed_apps.outputs.any_changed == 'true'
        run: |
          echo "ðŸ“ Committing config.json updates..."
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add apps/*/config.json
          git diff --staged --quiet && echo "No changes to commit" && exit 0
          git commit -m "ðŸ”§ Fixed: increment tipi_version for Docker image updates"
          git push origin HEAD:${{ github.event.pull_request.head.ref }}
          echo "âœ… Changes pushed successfully!"

      - name: Log successful config update
        if: steps.check_workflow_commit.outputs.skip_execution == 'false' && steps.changed_apps.outputs.any_changed == 'true'
        run: |
          echo "âœ… Config.json files successfully updated and committed!"
          echo "ðŸ”§ Updated files with new tipi_version for Docker image updates"

      - name: Validate JSON syntax
        if: steps.check_workflow_commit.outputs.skip_execution == 'false' && steps.changed_apps.outputs.any_changed == 'true'
        shell: pwsh
        env:
          CHANGED_FILES: ${{ steps.changed_apps.outputs.all_changed_files }}
        run: |
          echo "ðŸ” Validating JSON syntax..."
          pwsh ./.github/scripts/validate-json-syntax.ps1

      - name: Validate config.json structure
        if: steps.check_workflow_commit.outputs.skip_execution == 'false' && steps.changed_apps.outputs.any_changed == 'true'
        shell: pwsh
        env:
          CHANGED_FILES: ${{ steps.changed_apps.outputs.all_changed_files }}
        run: |
          echo "ðŸ” Validating config.json structure..."
          pwsh ./.github/scripts/validate-config-structure.ps1

      - name: Validate Docker Compose
        if: steps.check_workflow_commit.outputs.skip_execution == 'false' && steps.changed_apps.outputs.any_changed == 'true'
        shell: bash
        env:
          CHANGED_FILES: ${{ steps.changed_apps.outputs.all_changed_files }}
        run: |
          echo "ðŸ” Validating Docker Compose..."
          bash ./.github/scripts/validate-docker-compose.sh

      - name: Check if update is major version
        if: steps.check_workflow_commit.outputs.skip_execution == 'false' && steps.changed_apps.outputs.any_changed == 'true'
        id: check_major
        shell: pwsh
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          pwsh ./.github/scripts/check-major-version.ps1 -PrBody $env:PR_BODY
          
          # Detect update type from PR title/body
          if ($env:PR_BODY -match '\|\s*major\s*\|' -or $env:PR_TITLE -match 'major') {
            echo "update_type=major" >> $env:GITHUB_OUTPUT
          } elseif ($env:PR_BODY -match '\|\s*minor\s*\|' -or $env:PR_TITLE -match 'minor') {
            echo "update_type=minor" >> $env:GITHUB_OUTPUT
          } else {
            echo "update_type=patch" >> $env:GITHUB_OUTPUT
          }

      - name: Extract app and version info
        if: steps.check_workflow_commit.outputs.skip_execution == 'false' && steps.changed_apps.outputs.any_changed == 'true'
        id: extract_info
        run: |
          # Extract app name from changed files
          APP_NAME=$(echo "${{ steps.changed_apps.outputs.all_changed_files }}" | head -1 | sed 's|apps/\([^/]*\)/.*|\1|')
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          
          # Extract versions from PR title (format: "1.2.3 -> 1.2.4" or similar)
          OLD_VERSION=$(echo "${{ github.event.pull_request.title }}" | grep -oP '\d+\.\d+\.\d+' | head -1 || echo "unknown")
          NEW_VERSION=$(echo "${{ github.event.pull_request.title }}" | grep -oP '\d+\.\d+\.\d+' | tail -1 || echo "unknown")
          echo "old_version=$OLD_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Add semantic labels to PR
        if: steps.check_workflow_commit.outputs.skip_execution == 'false' && steps.changed_apps.outputs.any_changed == 'true' && success()
        run: |
          UPDATE_TYPE="${{ steps.check_major.outputs.update_type }}"
          APP_NAME="${{ steps.extract_info.outputs.app_name }}"
          
          echo "ðŸ·ï¸ Adding labels: ${UPDATE_TYPE}-update, app:${APP_NAME}"
          gh pr edit ${{ github.event.pull_request.number }} --add-label "${UPDATE_TYPE}-update" || true
          gh pr edit ${{ github.event.pull_request.number }} --add-label "app:${APP_NAME}" || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add approved-to-merge label to PR
        if: steps.check_workflow_commit.outputs.skip_execution == 'false' && steps.changed_apps.outputs.any_changed == 'true' && steps.check_major.outputs.is_major == 'false' && success()
        run: |
          echo "ðŸ·ï¸ Adding approved-to-merge label..."
          gh pr edit ${{ github.event.pull_request.number }} --add-label "approved-to-merge"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Approve PR for auto-merge
        if: steps.check_workflow_commit.outputs.skip_execution == 'false' && steps.changed_apps.outputs.any_changed == 'true' && steps.check_major.outputs.is_major == 'false' && success()
        run: |
          echo "âœ… Approving PR..."
          gh pr review ${{ github.event.pull_request.number }} --approve --body "âœ… Automated approval: All validations passed, tipi_version incremented."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable automerge for approved PR
        if: steps.check_workflow_commit.outputs.skip_execution == 'false' && steps.changed_apps.outputs.any_changed == 'true' && steps.check_major.outputs.is_major == 'false' && success()
        run: |
          echo "ðŸ”€ Enabling auto-merge..."
          if ! gh pr merge --squash --auto ${{ github.event.pull_request.number }}; then
            echo "âš ï¸ Auto-merge via CLI failed, trying direct merge..."
            # If auto-merge is not enabled in repo settings, try direct merge
            gh pr merge --squash ${{ github.event.pull_request.number }} --admin || {
              echo "âš ï¸ Direct merge also failed - check repo settings:"
              echo "   1. Settings â†’ General â†’ Pull Requests â†’ â˜‘ï¸ Allow auto-merge"
              echo "   2. Settings â†’ Branches â†’ main â†’ Allow bypass for github-actions[bot]"
              exit 0
            }
          fi
          echo "âœ… Auto-merge enabled successfully!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip automerge for major updates
        if: steps.check_workflow_commit.outputs.skip_execution == 'false' && steps.changed_apps.outputs.any_changed == 'true' && steps.check_major.outputs.is_major == 'true'
        run: |
          echo "ðŸš« Major version update detected - manual review required"
          echo "::warning::This PR contains a major version update and requires manual review before merging"
          gh pr edit ${{ github.event.pull_request.number }} --add-label "major-update" --add-label "needs-review"
          
          # Add comment explaining why manual review is needed
          gh pr comment ${{ github.event.pull_request.number }} --body "## âš ï¸ Major Version Update Detected

This PR contains a **major version update** which may include breaking changes.

### ðŸ“‹ Checklist before merging:
- [ ] Review release notes for breaking changes
- [ ] Test the new version locally if possible
- [ ] Update documentation if needed

*Automated by tipi-store workflow*"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Job Summary
        if: always() && steps.check_workflow_commit.outputs.skip_execution == 'false'
        run: |
          APP_NAME="${{ steps.extract_info.outputs.app_name }}"
          OLD_VER="${{ steps.extract_info.outputs.old_version }}"
          NEW_VER="${{ steps.extract_info.outputs.new_version }}"
          UPDATE_TYPE="${{ steps.check_major.outputs.update_type }}"
          IS_MAJOR="${{ steps.check_major.outputs.is_major }}"
          
          echo "## ðŸ”„ Renovate Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **App** | \`${APP_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | ${OLD_VER} â†’ ${NEW_VER} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Update Type** | ${UPDATE_TYPE} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Auto-merged** | $([[ "$IS_MAJOR" == "false" ]] && echo "âœ… Yes" || echo "âŒ No (manual review required)") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“ Actions Performed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Incremented \`tipi_version\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Updated \`updated_at\` timestamp" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Validated JSON syntax" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Validated config structure" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Validated Docker Compose" >> $GITHUB_STEP_SUMMARY
          
          if [[ "$IS_MAJOR" == "false" ]]; then
            echo "- âœ… Auto-approved and merged" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Awaiting manual review (major update)" >> $GITHUB_STEP_SUMMARY
          fi

  # Job for manual contributions - validates configurations only
  validate-manual-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request' && !(github.actor == 'renovate[bot]' || contains(github.event.pull_request.user.login, 'renovate'))
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get list of apps changed in the PR
        id: changed_apps
        uses: tj-actions/changed-files@v46
        with:
          files: |
            apps/*/docker-compose.json
            apps/*/config.json
            apps/*/metadata/**

      - name: Validate JSON syntax
        if: steps.changed_apps.outputs.any_changed == 'true'
        shell: pwsh
        env:
          CHANGED_FILES: ${{ steps.changed_apps.outputs.all_changed_files }}
        run: |
          pwsh ./.github/scripts/validate-json-syntax.ps1

      - name: Validate config.json structure
        if: steps.changed_apps.outputs.any_changed == 'true'
        shell: pwsh
        env:
          CHANGED_FILES: ${{ steps.changed_apps.outputs.all_changed_files }}
        run: |
          pwsh ./.github/scripts/validate-config-structure.ps1

      - name: Test Docker Compose validity
        if: steps.changed_apps.outputs.any_changed == 'true'
        shell: bash
        env:
          CHANGED_FILES: ${{ steps.changed_apps.outputs.all_changed_files }}
        run: |
          bash ./.github/scripts/validate-docker-compose.sh

      - name: Validation Summary
        if: always()
        run: |
          echo "ðŸ“‹ Configuration validation completed for PR #${{ github.event.pull_request.number }}"
          echo "ðŸ” Changed files: ${{ steps.changed_apps.outputs.all_changed_files }}"
          echo "â„¹ï¸  This PR requires manual review as it's not from Renovate Bot"
          
          # Generate Job Summary for manual PRs
          echo "## ðŸ“‹ Manual PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changed Files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.changed_apps.outputs.all_changed_files }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Manual Review Required" >> $GITHUB_STEP_SUMMARY
          echo "This PR was not created by Renovate and requires manual review before merging." >> $GITHUB_STEP_SUMMARY
